<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="thermophysicalModels LIB in OpenFOAM"><meta name="keywords" content="thermophysicalModels"><meta name="author" content="Yan Zhang"><meta name="copyright" content="Yan Zhang"><title>thermophysicalModels LIB in OpenFOAM | OpenFOAM using &amp; programming skills</title><link rel="shortcut icon" href="/en/album/linktocat.ico"><link rel="stylesheet" href="/en/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?38997e7d3b8e8c254bf0ddb7d2452127";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-119919860-1","auto"),ga("send","pageview")</script><script>var GLOBAL_CONFIG={root:"/en/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"We didn't find any results for the search: ${query}"}},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"},hexoVersion:"5.0.2"}</script><meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="/en/atom.xml" title="OpenFOAM using & programming skills" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#uml-%E7%B1%BB%E5%9B%BE"><span class="toc-number">1.</span> <span class="toc-text">UML 类图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B1%82%E8%A7%A3%E5%99%A8%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.</span> <span class="toc-text">求解器中创建对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rts-%E9%80%89%E6%8B%A9%E7%83%AD%E7%89%A9%E7%90%86%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">RTS 选择热物理模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E5%AD%97%E5%85%B8%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E7%BD%AE%E5%88%B0%E6%9C%80%E7%BB%88%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%9E%84%E5%BB%BA"><span class="toc-number">3.1.</span> <span class="toc-text">从字典文件中的设置到最终的对象构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#definethermophysicsreactionthermo"><span class="toc-number">3.2.</span> <span class="toc-text">defineThermoPhysicsReactionThermo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#makethermophysicsreactionthermos"><span class="toc-number">3.3.</span> <span class="toc-text">makeThermoPhysicsReactionThermos</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/album/192.jpg"></div><div class="author-info__name text-center">Yan Zhang</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ZhangYanTJU">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/en/archives"><span class="pull-left">Articles</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/en/tags"><span class="pull-left">Tags</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/en/categories"><span class="pull-left">Categories</span><span class="pull-right">9</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"><a id="site-name" href="/en/">OpenFOAM using &amp; programming skills</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"> <a class="site-page" href="/en">Home</a><a class="site-page" href="/en/about">About</a><a class="site-page" href="/en/subscribe">Subscribe</a><a class="site-page" href="../">简体中文</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">thermophysicalModels LIB in OpenFOAM</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> created 2018-03-03<span class="post-meta__separator">|</span><i class="fa fa-calendar-check-o" aria-hidden="true"></i> updated 2018-05-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/en/categories/OpenFOAM/">OpenFOAM</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/en/categories/OpenFOAM/code-analysis/">code analysis</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2k</span><span class="post-meta__separator">|</span><span>Reading time: 9 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>This post analyze classes about species, mixture and thermo in thermophysicalModels LIB.</p><a id="more"></a><div id="google_translate_element"></div><script type="text/javascript">function googleTranslateElementInit(){new google.translate.TranslateElement({pageLanguage:"zh-CN",layout:google.translate.TranslateElement.InlineLayout.SIMPLE,multilanguagePage:!0,gaTrack:!0,gaId:"UA-119919860-1"},"google_translate_element")}</script><script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script><h1 id="uml-类图"><a class="markdownIt-Anchor" href="#uml-类图"></a> UML 类图</h1><p>下图是热物理库部分类的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://baike.baidu.com/item/%E7%BB%9F%E4%B8%80%E5%BB%BA%E6%A8%A1%E8%AF%AD%E8%A8%80/3160571?fr=aladdin&amp;fromid=446747&amp;fromtitle=UML">UML 类图</a> 。欲获取更佳阅读体验，可以右键在新标签页打开该图。</p><img src="http://www.plantuml.com/plantuml/svg/hHfPRnj5-Ds_OjHAbbFSghpQ8L8QagPIBpKMLGKecgp7sOMzs5qxX12fegW7L9GN1ArQ2QGY8gHI97Xe2nL_9axR9_u2S-tkpExCxevD7rBFVCTyrtp7s2tBXN4CuX1P3W9xBO3_RMw2ov4pWGa2GvX0lARR9tU2Q0Xyw26-ZYtemWXSavTUu5v5phQTRARCBY1l2qLWDFQjn0dyE6NubeKN2I1isvHlPm7GBGRb_AugTwyfTwzak_kj5jTfyVEJms37Fmb258sGbPo5SGziK5YBAPy35jd-qbwjwFp0o0uwONUWacLT1rW9TP2D4Y2C7JsR2oiJ4OXLpZN9rVu8-d0qi57a1Jsm-iaO4aKkZJOIx5zk005biO2nL1qIN9Q16-niTi70ndud_rk1vmK-nx42D1ejHn7S1GI-4gwGZRWCnKnaO0C7a9ELeK1bKKEOT3ACXM8kJ5kIjGvNaBnZvl9rg8N4MeZLgOiUiWzQ--HFAqP-x6ovQDLFREY6ktbei1iIzte9zJteWS5kYCe4fqw98KBGs0V2dkUF0iaYmsXoaN2KEHR8SajdOIz2oJZomJ7xM7-_OCP9Xwd7sBS14xmhABu7E3a3dQAc1uE5Fi3MA70xiqiu0XrBm7b-uETStoxpMLyrOy45e_vL2ZRGShG9pzDwdWFCrEu2mlSqOKmZW0Q1wByg_zCFBR4eP63kqouDagKzBhIG6RYFrue-ph84w8oe0jqEuzZhdLXR41R3jU50NBkEvoGBOgmto0WqAG9DojJ3jg7dmGfA5YiwEFQO3hGQwq7w0yzg8LQe1TbwVhPU2bkTJYe8a5uulOcGdY7IoxsjXP1RiavYVN0QgE5nPptkLi1XDJrst6eb71RX8Fl7BbxQW-GtBBzwOxBZGdyuYA0VXq6K56zV6QEKLQjgyd9CAd7pIkgDjQR-68QXtaKutzlGbi3xMFKj63lM1UTJd9-49epjZjt4MGcyCF2Hdt0ShhOUGT0wI72NWuQItiUvhGSGrw4qTt7GUITE5hU2m5q246i_uHtiySj9H46JmDsWogmvo1qkfIrjVUygdjbEL_9r8iUITG8TF-w8BIz3luYBNfc0YTbnuHPoEQAZQ49onTefYOGr2PmXBix9iegTZ7BEXteaZQ7Qf0yNvQd2a-KIuGJCwDdPZiIp3hS9tvB1cnoWyP9qnzCuLmLi8UhPRA68TWcGHVdXNpyVFllww8UdhruyVNt_mVJMowFlViylBNCF1bCp_FlttH3NLxm4x5PoSpXHCeOko4OfEPB0E-2q4X4tJHnJRAsqs1CJR9nsJR1Z8sohgOOR9cnNZOGuQuAyR8ACKxG1DilQ1WGyaOiKrGHa-bNpBrqGASRpY-4fAu5obqmXYfgODQrqT66tIac_cAFL5D0qYGa4QMf_5-DnB6-Sq4gJOm6FdLIBy5xWrXUOr__SVtFhxlIt1uVFxno-kFdwpuCtj-vDRz_4MM3wrOz7ZsvCd_ynVNHBJ6JvIMrW8TVbcalvakohAeb86yB4ijUWXLGCAD3fYbiZZ5h7avoBzKuvud3fpYnM1Hy3wHHkRej-JYjMEe-A8P0EfhHuHWWEkOc63lKYZ7RR2tsT7jieEH_W6yJs9EFAsKjryliSvSF-FcsplEhAWsN34ldRwTKgh0qkLO5IkawWkY5bubCXOuVOH-hHXFrDFWXpOpYVeQ8JKgTTeT84lYZ6Kg_7I5BlI3rQyVZKryA-nkEYWFrzkSK7BQdjn7OlsnoEam3BhGPoXTJ0ahiebfHBUu1_45mb8ImAy3pnPNcbd9qFdprvzU3BeplNZnxUAVOUNEVMkKjvf1VQ76c84NRsWFXYeEpWf_U-8DdjzlUlVpfWKf2cncQ5AG5lRhma3Gxtgj2nCMgnQSFuCUtPEETYYnSgzy50lKtFvw2D7GTd630CXmqUkDDwMJe-xPfJ17KZ6XQQvahaWHfPXPQ5S0EsLFSgEU8oDal2qbCa9HHiLxngr9xz_Jn4gjlVN3kSVwqWYd0qOPQbHYNnmj9mHxeMRIj42E8YjgnFYQPeCXkfH56RrqRLiXI5fsylW-RYswKIIR8DAyUnCPiQGoW5jWoCJTvqs1ldt18Bh6QGUYKqa9gzxizqpCJacCcinx2tpUOdfM-Xi-aK6YaLJcO_YBt9cXoMlkBETE1LiwlAvg_cql5NDdEvAE7gQDHHfXX30GWVLczdCH6bp5aqFxj0M3vRg5XP5o9q5taJCdB7pZ1jGd3d5g6OVZMLDRSNWY5kBcad9U7IXaNO4HkMsWglCeO_LjVDal8OiJp3vELpzf9unGxKGG6m2HA8mOqB5VacsYWKlB51x7jL5Y3agSi5_mZVxCUEvCHitQ3dBBHwc7IphuHuuys-m4w8FTQgYawPFZmuUlAOzTW4kTXgrRGb3LgIYdX99HHCrK32kOAeRnX19j4pJ-G8irghbKM553Zf85aC87c_zbKsIqwfeEMv2hSmqgY9mxelaJ2PwmcpMz6Nig7cYSr6sTVsugHOKb59SQOqqQN0HG7K1TACQNhdR2JThFfSYqyXFnKGJ-trnE-Rw3kBPBHqpZYHs4wSlTv8Xf-5hJp4A9dJNpQmh_yk2hznIccamvBiCGD_ndyP0UUeIZhJnx-ykN4mlNspucxN3okfBCGH-sPJImLfxVZoFumknYpa164olZIPDr23sSM03m06agj6aZaKNmaRAix7adcEcZIl2z8eqtYCcTsCyoiN6cXN66aCnfav9BpQN3vff6aqpimXLwEnnd2acKCSzMXZEDRepoTFNwsiyWgr-7AXkHLsM0tEbXLbkEO7MgpTWwurTZ4UVvnKrPkZXzUdttvp-EpwuRDV3KgEz4YNzop_0G00"><h1 id="求解器中创建对象"><a class="markdownIt-Anchor" href="#求解器中创建对象"></a> 求解器中创建对象</h1><p><code>solver</code> 中的 <code>creatFields.H</code> 中：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">autoPtr&lt;psiReactionThermo&gt; pThermo(psiReactionThermo::New(mesh));</span><br><span class="line">psiReactionThermo&amp; thermo &#x3D; pThermo();</span><br></pre></td></tr></table></figure><p>创建 <code>thermo</code>，在 <code>reactingFoam</code> 自带算例中，创建的是 <code>hePsiThermo</code> 的对象，但是这里 thermo 是基类 <code>psiReactionThermo</code> 的引用，即只能使用 <code>psiReactionThermo</code> 这一继承链的方法。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">basicSpecieMixture&amp; composition &#x3D; thermo.composition();</span><br></pre></td></tr></table></figure><p>创建composition，是指系统中的混合物。可以调用继承链中 <code>mixture</code> 这一分支的方法。</p><p>燃烧类的求解器中，一般都没有对单个组分进行操作，这些操作都在热物理库里边进行。</p><p><code>multiComponentMixture</code> 类中的私有数据 <code>speciesData_</code> 的类型是 <code>PtrList&lt;sutherlandTransport&lt;species::thermo&lt;janafThermo&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;&gt;</code>，它是组分的 <code>list</code>，可以用它获取组分的所有信息。solver 中可以通过 <code>multiComponentMixture</code> （<code>solver</code> 中<code>composition</code> 的类型是 <code>basicSpecieMixture</code>，需要强制转换成 <code>multiComponentMixture</code> 才行 ） 的 <code>speciesData()</code> 或者 <code>getLocalThermo(speciei)</code> 这两个函数来调用。如：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dynamic_cast&lt;const multiComponentMixture&lt;gasHThermoPhysics&gt;&amp;&gt;(composition).speciesData()[speciei].rho(p,T)</span><br></pre></td></tr></table></figure><p>也可以通过 <code>multiComponentMixture</code> 的派生类 <code>reactingMixture</code> 来调用。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dynamic_cast&lt;const reactingMixture&lt;gasHThermoPhysics&gt;&amp;&gt;(composition).speciesData()[speciei].rho(p,T)</span><br></pre></td></tr></table></figure><p>也可以通过派生类的派生类 <code>SpecieMixture</code> 来调用。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dynamic_cast&lt;const SpecieMixture&lt;reactingMixture&lt;gasHThermoPhysics&gt;&gt;&amp;&gt;(composition).speciesData()[speciei].rho(p,T)</span><br></pre></td></tr></table></figure><p>上述操作说明可以使用组分列表调用单个组分的函数（即 <code>sutherlandTransport&lt;species::thermo&lt;janafThermo&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;</code> 继承链中的任何函数），如 <code>speciesData_[i].rho(p, T)</code>，这里的 <code>rho(p,T)</code> 来自于 <code>perfectGas</code> 类。</p><p>也可以在求解器中重新构造组分列表：</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">autoPtr&lt;psiReactionThermo&gt; <span class="title">pThermo</span><span class="params">(psiReactionThermo::New(mesh))</span></span>;</span><br><span class="line">psiReactionThermo&amp; thermo = pThermo();</span><br><span class="line"></span><br><span class="line">basicSpecieMixture&amp; composition = thermo.composition();</span><br><span class="line">PtrList&lt;volScalarField&gt;&amp; Y = composition.Y();</span><br><span class="line"></span><br><span class="line"><span class="function">PtrList&lt;gasHThermoPhysics&gt; <span class="title">specieData</span><span class="params">(Y.<span class="built_in">size</span>())</span></span>;</span><br><span class="line">forAll(specieData, i)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//对于每个组分，通过 thermo 调用 Lib 中的 speciesData_ 来构造 solver 中的 specieData</span></span><br><span class="line">    specieData.<span class="built_in">set</span></span><br><span class="line">    (</span><br><span class="line">        i,</span><br><span class="line">        <span class="keyword">new</span> gasHThermoPhysics</span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">dynamic_cast</span>&lt;<span class="keyword">const</span> reactingMixture&lt;gasHThermoPhysics&gt;&amp;&gt;</span><br><span class="line">                (thermo).speciesData()[i]</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每个网格构造一个 mixture,这个 mixture 相当于 multiComponentMixture 中的私有数据 mixture_。</span></span><br><span class="line"><span class="comment">// 它是混合物等效成的一个组分，和单个组分同一类型，即 `gasHThermoPhysics`。</span></span><br><span class="line">forAll(T, celli)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">gasHThermoPhysics <span class="title">mixture</span><span class="params">(<span class="number">0.</span>*specieData[<span class="number">0</span>])</span></span>;</span><br><span class="line">    forAll(Y, speciei)</span><br><span class="line">    &#123;</span><br><span class="line">        mixture += Y[speciei][celli]*specieData[speciei];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gasHThermoPhysics</code> 是 <code>sutherlandTransport&lt;species::thermo&lt;janafThermo&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;</code> 的别名，它是单个组分的类型。<br>事实上，<code>multiComponentMixture</code> 类中的函数 <code>cellMixture</code> 函数可以用于获取 <code>mixture_</code>。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ThermoType</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">const</span> <span class="title">ThermoType</span>&amp; <span class="title">Foam</span>:</span>:multiComponentMixture&lt;ThermoType&gt;::cellMixture</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">const</span> label celli</span><br><span class="line">) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    mixture_ = Y_[<span class="number">0</span>][celli]*speciesData_[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (label n=<span class="number">1</span>; n&lt;Y_.<span class="built_in">size</span>(); n++)</span><br><span class="line">    &#123;</span><br><span class="line">        mixture_ += Y_[n][celli]*speciesData_[n];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mixture_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用方法参考 <code>hePsiThermo.C</code>:</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> scalarField&amp; hCells = <span class="keyword">this</span>-&gt;he_;</span><br><span class="line"><span class="keyword">const</span> scalarField&amp; pCells = <span class="keyword">this</span>-&gt;p_;</span><br><span class="line"></span><br><span class="line">scalarField&amp; TCells = <span class="keyword">this</span>-&gt;T_.primitiveFieldRef();</span><br><span class="line">scalarField&amp; psiCells = <span class="keyword">this</span>-&gt;psi_.primitiveFieldRef();</span><br><span class="line">scalarField&amp; muCells = <span class="keyword">this</span>-&gt;mu_.primitiveFieldRef();</span><br><span class="line">scalarField&amp; alphaCells = <span class="keyword">this</span>-&gt;alpha_.primitiveFieldRef();</span><br><span class="line"></span><br><span class="line">forAll(TCells, celli)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> MixtureType::thermoType&amp; mixture_ =</span><br><span class="line">        <span class="keyword">this</span>-&gt;cellMixture(celli);</span><br><span class="line"></span><br><span class="line">    TCells[celli] = mixture_.THE</span><br><span class="line">    (</span><br><span class="line">        hCells[celli],</span><br><span class="line">        pCells[celli],</span><br><span class="line">        TCells[celli]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    psiCells[celli] = mixture_.psi(pCells[celli], TCells[celli]);</span><br><span class="line"></span><br><span class="line">    muCells[celli] = mixture_.mu(pCells[celli], TCells[celli]);</span><br><span class="line">    alphaCells[celli] = mixture_.alphah(pCells[celli], TCells[celli]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="rts-选择热物理模型"><a class="markdownIt-Anchor" href="#rts-选择热物理模型"></a> RTS 选择热物理模型</h1><h2 id="从字典文件中的设置到最终的对象构建"><a class="markdownIt-Anchor" href="#从字典文件中的设置到最终的对象构建"></a> 从字典文件中的设置到最终的对象构建</h2><p>下面介绍我们是如何从 <code>thermophysicalProperties</code> 字典文件中的下列设置构建对象的：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">thermoType</span><br><span class="line">&#123;</span><br><span class="line">    type            hePsiThermo;</span><br><span class="line">    mixture         reactingMixture;</span><br><span class="line">    transport       sutherland;</span><br><span class="line">    thermo          janaf;</span><br><span class="line">    energy          sensibleEnthalpy;</span><br><span class="line">    equationOfState perfectGas;</span><br><span class="line">    specie          specie;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先需要一个函数读取这些信息：</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://cpp.openfoam.org/v3/a09872_source.html">basicThermoTemplates.C</a> 中的 <code>lookupThermo</code> 函数：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">template&lt;class Thermo, class Table&gt;</span><br><span class="line">typename Table::iterator Foam::basicThermo::lookupThermo</span><br><span class="line">(</span><br><span class="line">    const dictionary&amp; thermoDict,</span><br><span class="line">    Table* tablePtr    &#x2F;&#x2F;即 fvMeshConstructorTablePtr_</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Construct the name of the thermo package from the components</span><br><span class="line">    const word thermoTypeName</span><br><span class="line">    (</span><br><span class="line">    word(thermoTypeDict.lookup(&quot;type&quot;)) + &#39;&lt;&#39;</span><br><span class="line">    + word(thermoTypeDict.lookup(&quot;mixture&quot;)) + &#39;&lt;&#39;</span><br><span class="line">    + word(thermoTypeDict.lookup(&quot;transport&quot;)) + &#39;&lt;&#39;</span><br><span class="line">    + word(thermoTypeDict.lookup(&quot;thermo&quot;)) + &#39;&lt;&#39;</span><br><span class="line">    + word(thermoTypeDict.lookup(&quot;equationOfState&quot;)) + &#39;&lt;&#39;</span><br><span class="line">    + word(thermoTypeDict.lookup(&quot;specie&quot;)) + &quot;&gt;&gt;,&quot;</span><br><span class="line">    + word(thermoTypeDict.lookup(&quot;energy&quot;)) + &quot;&gt;&gt;&gt;&quot;</span><br><span class="line">    );</span><br><span class="line">    &#x2F;&#x2F;通过字典文件读入的数据，构造 thermoTypeName: &#x2F;&#x2F;hePsiThermo&lt;reactingMixture&lt;sutherland&lt;janaf&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">    return lookupThermo&lt;Thermo, Table&gt;</span><br><span class="line">    (</span><br><span class="line">    thermoTypeDict,</span><br><span class="line">    tablePtr,</span><br><span class="line">    nCmpt,</span><br><span class="line">    cmptNames,</span><br><span class="line">    thermoTypeName</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后返回值是调用 5 个参数的 <code>lookupThermo</code> 函数：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">template&lt;class Thermo, class Table&gt;</span><br><span class="line">typename Table::iterator Foam::basicThermo::lookupThermo</span><br><span class="line">(</span><br><span class="line">    const dictionary&amp; thermoTypeDict,</span><br><span class="line">    Table* tablePtr,</span><br><span class="line">    const int nCmpt,</span><br><span class="line">    const char* cmptNames[],</span><br><span class="line">    const word&amp; thermoTypeName</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Lookup the thermo package</span><br><span class="line">    typename Table::iterator cstrIter &#x3D; tablePtr-&gt;find(thermoTypeName);</span><br><span class="line">    return cstrIter;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;上述步骤是根据字典文件在备选库中选择我们需要的组合，那么备选库是怎么形成的呢？</span><br></pre></td></tr></table></figure><p>第一个 <code>lookupThermo</code> 函数的作用是，将<code>thermophysicalProperties</code> 字典文件中的设置翻译成：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hePsiThermo&lt;reactingMixture&lt;sutherland&lt;janaf&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>但该字符串并不是最终的 <code>class</code>，比如 <code>janaf</code>，实际上类名是 <code>janafThermo</code>。</p><p>第二个 <code>lookupThermo</code> 函数的作用就是，根据该字符串，在 <code>RTS</code> 库中找到我们选择的类。</p><p>找到之后，在下面这个 <code>New</code> 函数中新建对象：</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Thermo</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">Foam</span>:</span>:autoPtr&lt;Thermo&gt; Foam::basicThermo::New(<span class="keyword">const</span> fvMesh&amp; mesh,<span class="keyword">const</span> <span class="keyword">word</span>&amp; phaseName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typename</span> Thermo::fvMeshConstructorTable::iterator cstrIter =</span><br><span class="line">        lookupThermo&lt;Thermo, <span class="keyword">typename</span> Thermo::fvMeshConstructorTable&gt;</span><br><span class="line">        (</span><br><span class="line">            thermoDict,</span><br><span class="line">            Thermo::fvMeshConstructorTablePtr_   </span><br><span class="line">        );</span><br><span class="line"><span class="comment">//fvMeshConstructorTablePtr_ </span></span><br><span class="line"><span class="comment">//这个是在 runTimeSelectionTables.H 的 declareRunTimeSelectionTable 函数中定义的。    </span></span><br><span class="line">    <span class="keyword">return</span> autoPtr&lt;Thermo&gt;(cstrIter()(mesh, phaseName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么上面提到的字符串，怎么和 <code>RTS</code> 库中的组合匹配的呢？下面来看 <code>RTS</code> 库的生成过程。</p><p>按照<a target="_blank" rel="external nofollow noopener noreferrer" href="http://xiaopingqiu.github.io/2016/03/12/RTS1/">Giskard的博客</a>提到的 <code>RTS</code> 流程：</p><blockquote><ol><li>基类类体里调用 <code>TypeName</code> 和 <code>declareRunTimeSelectionTable</code> 两个函数，类体外面调用 <code>defineTypeNameAndDebug</code> ， <code>defineRunTimeSelectionTable</code> 和 <code>addToRunTimeSelectionTable</code> 三个函数；</li><li>基类中需要一个静态 <code>New</code> 函数作为 <code>selector</code>。</li><li>派生类类体中需要调用 <code>TypeName</code> 函数，类体外调用 <code>defineRunTimeSelectionTable</code> 和 <code>addToRunTimeSelectionTable</code> 两个宏函数。</li></ol></blockquote><p><code>makeReactionThermo.H</code> 中有两个个重要函数：<code>defineThermoPhysicsReactionThermo</code> 和 <code>makeThermoPhysicsReactionThermos</code>。</p><p>下面一一介绍：</p><h2 id="definethermophysicsreactionthermo"><a class="markdownIt-Anchor" href="#definethermophysicsreactionthermo"></a> defineThermoPhysicsReactionThermo</h2><p>其中的 <code>defineThermoPhysicsReactionThermo</code>, 这个函数通过一组形参列表得到 <code>CThermo##Mixture##ThermoPhys</code>，然后再转换成一串简化的字符串，用于 <code>RTS</code> 查询。这里的形参列表就是实例化所需要提供的各种类。<code>(BaseReactionThermo,CThermo,Mixture,ThermoPhys)</code>对应<code>(psiReactionThermo,hePsiThermo,reactingMixture,sutherlandTransport)</code>。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> defineThermoPhysicsReactionThermo(BaseReactionThermo,CThermo,Mixture,ThermoPhys) \</span></span><br><span class="line">    <span class="keyword">typedef</span> CThermo<span class="comment">//hePsiThermo                                                         \</span></span><br><span class="line">    &lt;                                                                                    \</span><br><span class="line">        BaseReactionThermo,<span class="comment">//psiReactionThermo                                           \</span></span><br><span class="line">        SpecieMixture                                                                    \</span><br><span class="line">        &lt;                                                                                \</span><br><span class="line">            Mixture<span class="comment">//reactingMixture                                                     \</span></span><br><span class="line">            &lt;                                                                            \</span><br><span class="line">                ThermoPhys<span class="comment">//sutherlandTransport                                          \</span></span><br><span class="line">            &gt;                                                                            \</span><br><span class="line">        &gt;                                                                                \</span><br><span class="line">    &gt; CThermo##Mixture##ThermoPhys;                                                      \</span><br><span class="line">                                                                                         \</span><br><span class="line">    defineTemplateTypeNameAndDebugWithName                                               \</span><br><span class="line">    (                                                                                    \</span><br><span class="line">        CThermo##Mixture##ThermoPhys,                                                    \</span><br><span class="line">        (#CThermo<span class="string">&quot;&lt;&quot;</span> + Mixture&lt;ThermoPhys&gt;::typeName() + <span class="string">&quot;&gt;&quot;</span>).c_str(),                   \</span><br><span class="line">        <span class="number">0</span>                                                                                \</span><br><span class="line">    )</span><br><span class="line"><span class="comment">//作用：把尖括号表示的类变成字符串 CThermo##Mixture##ThermoPhys，然后再变成简化的尖括号。</span></span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">hePsiThermo</span><br><span class="line">&lt;</span><br><span class="line">psiReactionThermo,</span><br><span class="line">    SpecieMixture</span><br><span class="line">    &lt;</span><br><span class="line">        reactingMixture</span><br><span class="line">        &lt;</span><br><span class="line">            sutherlandTransport</span><br><span class="line">            &lt;</span><br><span class="line">                species::thermo</span><br><span class="line">                &lt;</span><br><span class="line">                    janafThermo&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy</span><br><span class="line">                &gt;</span><br><span class="line">            &gt;</span><br><span class="line">        &gt;</span><br><span class="line">    &gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>变成 <code>RTS</code> 库中保存的字符串：<br><code>hePsiThermo&lt;reactingMixture&lt;sutherland&lt;janaf&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;&gt;</code><br>隐藏了一些信息，如 <code>psiReactionThermo</code>和 <code>SpecieMixture</code> 。</p><p>具体过程：<br><code>typeName()</code> 依次调用 <code>reactingMixture</code>，<code>sutherlandTransport</code>, <code>species::thermo</code>, <code>janafThermo</code>, <code>sensibleEnthalpy</code>, <code>perfectGas</code>, <code>specie</code> 的 <code>typeName()</code>。返回值依次是：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;reactingMixture&lt;&quot; + ThermoType::typeName() + &#39;&gt;&#39;</span><br><span class="line">sutherland&lt;&quot; + Thermo::typeName() + &#39;&gt;&#39;</span><br><span class="line">Thermo::typeName() + &#39;,&#39; + Type&lt;thermo&lt;Thermo, Type&gt;&gt;::typeName()</span><br><span class="line">&quot;janaf&lt;&quot; + EquationOfState::typeName() + &#39;&gt;&#39;</span><br><span class="line">&quot;sensibleEnthalpy&quot;</span><br><span class="line">&quot;perfectGas&lt;&quot; + word(Specie::typeName_()) + &#39;&gt;&#39;</span><br></pre></td></tr></table></figure><p>最底层的 <code>specie</code> 类只有一个 <code>ClassName(&quot;specie&quot;)</code>;<br>我们找到一个文件<code>className.H</code> 中：</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ClassName(TypeNameString)                             \</span></span><br><span class="line">	ClassNameNoDebug(TypeNameString);                         \</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> debug</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ClassNameNoDebug(TypeNameString)                      \</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">typeName_</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> TypeNameString; &#125; \</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> ::Foam::<span class="keyword">word</span> typeName                 </span><br></pre></td></tr></table></figure><h2 id="makethermophysicsreactionthermos"><a class="markdownIt-Anchor" href="#makethermophysicsreactionthermos"></a> makeThermoPhysicsReactionThermos</h2><p>调用了上边的 <code>defineThermoPhysicsReactionThermo</code> 用于创建 <code>RTS</code> 中的 <code>typeName</code>，调用了 <code>addThermoPhysicsThermo</code>（位于 <code>makeThermo.H</code>）, 用于写入到 <code>RTS</code> 库。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> makeThermoPhysicsReactionThermos(BaseThermo,BaseReactionThermo,CThermo,Mixture,ThermoPhys)  \                                                                          </span></span><br><span class="line">    defineThermoPhysicsReactionThermo(BaseReactionThermo,CThermo,Mixture,ThermoPhys);               \                                                                      </span><br><span class="line">                                                                                                    \</span><br><span class="line">    addThermoPhysicsThermo(basicThermo, CThermo##Mixture##ThermoPhys);                              \</span><br><span class="line">    addThermoPhysicsThermo(fluidThermo, CThermo##Mixture##ThermoPhys);                              \</span><br><span class="line">    addThermoPhysicsThermo(BaseThermo, CThermo##Mixture##ThermoPhys);                               \</span><br><span class="line">    addThermoPhysicsThermo(BaseReactionThermo, CThermo##Mixture##ThermoPhys)</span><br></pre></td></tr></table></figure><p>函数的形参：<code>(BaseThermo,BaseReactionThermo,CThermo,Mixture,ThermoPhys)</code>，这是实例化需要提供的所有信息，比如其中的一种组合：<code>(psiThermo,psiReactionThermo,hePsiThermo,reactingMixture,gasHThermoPhysics)</code>（所有可能的组合在 <code>psiReactionThermos.C</code> 文件中列出）。</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> addThermoPhysicsThermo(BaseThermo,CThermoMixtureThermoPhys) <span class="comment">//定义于makeThermo.H  </span></span></span><br><span class="line">    addToRunTimeSelectionTable                                                       \</span><br><span class="line">    (                                                                                \</span><br><span class="line">        BaseThermo,                                                                  \</span><br><span class="line">        CThermoMixtureThermoPhys,                                                    \</span><br><span class="line">        fvMesh                                                                       \</span><br><span class="line">    );  </span><br></pre></td></tr></table></figure><p>这里到底往 <code>RTS Table</code> 里 <code>add</code> 了什么？<br><code>BaseThermo</code> 是 <code>psiThermo</code>，<code>CThermoMixtureThermoPhys</code> 是<code>hePsiThermo##reactingMixture##gasHThermoPhysics</code>。</p><p>那前边提到的保存在 <code>RTS</code> 中的简化的尖括号字符串是干嘛的？</p><p><code>hePsiThermo&lt;reactingMixture&lt;sutherland&lt;janaf&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt;&gt;</code></p><p>其实这两个的含义是一样的，因为</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef</span><br><span class="line">sutherlandTransport</span><br><span class="line">&lt;</span><br><span class="line">    species::thermo</span><br><span class="line">    &lt;</span><br><span class="line">        janafThermo</span><br><span class="line">        &lt;</span><br><span class="line">            perfectGas&lt;specie&gt;</span><br><span class="line">        &gt;,</span><br><span class="line">        sensibleEnthalpy</span><br><span class="line">    &gt;</span><br><span class="line">&gt; gasHThermoPhysics;</span><br></pre></td></tr></table></figure><p>即 <code>typedef sutherlandTransport&lt;species::thermo&lt;janafThermo&lt;perfectGas&lt;specie&gt;&gt;,sensibleEnthalpy&gt;&gt; gasHThermoPhysics;</code>。</p><p>但是此二者在 <code>RTS</code> 里边有什么联系呢？</p></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">Yan Zhang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://openfoam.top/thermodynamicLIB/">https://openfoam.top/thermodynamicLIB/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/thermophysicalModels/">thermophysicalModels</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/album/wechatPay.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right" data-disabled="tencent,douban,qzone,diandian"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/en/qtcreator/"><i class="fa fa-chevron-left"></i><span>debug with qtcreator</span></a></div><div class="next-post pull-right"><a href="/en/T_calculate/"><span>How to get temperature from enthalpy in OpenFOAM?</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk=new Gitalk({clientID:"9dfad189aeefc4c2dde2",clientSecret:"69b4d95e0c4be2508135adae20b05bf6f298f386",repo:"zhangyantju.github.io",owner:"ZhangYanTJU",admin:"ZhangYanTJU",id:md5(decodeURI(location.pathname)),language:"en"});gitalk.render("gitalk-container")</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By Yan Zhang</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="external nofollow noopener noreferrer" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hosted by <a target="_blank" rel="external nofollow noopener noreferrer" href="https://pages.coding.me"><b>Coding Pages</b></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/en/js/utils.js?version=1.8.2"></script><script src="/en/js/fancybox.js?version=1.8.2"></script><script src="/en/js/sidebar.js?version=1.8.2"></script><script src="/en/js/copy.js?version=1.8.2"></script><script src="/en/js/fireworks.js?version=1.8.2"></script><script src="/en/js/transition.js?version=1.8.2"></script><script src="/en/js/scroll.js?version=1.8.2"></script><script src="/en/js/head.js?version=1.8.2"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/en/js/katex.js"></script><script src="/en/js/search/local-search.js"></script><script>/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"),$("#top-container").addClass("is-mobile"))</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49b1f5">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>